name: ai-context guard

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  repo-root:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install validator deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      - name: Validate repo .ai-context.yml (if present)
        run: |
          # Rollout-Regel (wichtig, wenn dieser Patch in alle Repos eingespeist wird):
          # - In NON-metarepo Repos muss nur /.ai-context.yml sinnvoll bef체llt sein.
          # - ai-contexts/ (Templates) ist dort optional und wird hier NICHT verlangt.
          # - In metarepo wird zus채tzlich ein Template-Job aktiv (siehe unten).
          if [ -f ".ai-context.yml" ]; then
            python scripts/ai_context/validate_ai_context.py --file ".ai-context.yml"
          else
            echo "INFO: .ai-context.yml missing (allowed during rollout, but should be added)."
          fi

  templates:
    # Template-Validierung ist NUR f체r metarepo gedacht.
    # In allen anderen Repos wird dieser Job automatisch 체bersprungen,
    # weil ai-contexts/ dort typischerweise nicht existiert.
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install validator deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      - name: Validate templates (metarepo only)
        run: |
          if [ -d "ai-contexts" ]; then
            python scripts/ai_context/validate_ai_context.py --templates-dir "ai-contexts"
          else
            echo "INFO: ai-contexts/ not present -> skipping template validation."
          fi
