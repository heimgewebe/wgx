name: validate-agent-workflows
on:
  pull_request:
    paths:
      - "agents/**/*.workflow.json"
      - "**/*.agent.workflow.json"
  push:
    paths:
      - "agents/**/*.workflow.json"
      - "**/*.agent.workflow.json"
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8ade135a242bde00fd19c0e54fb3760beea110ee # v4.1.0
      - uses: actions/setup-node@5e221d4786ffb21088b21dfc9c80efb16b52cd3b # v4.0.2
      - name: Install ajv-cli
        run: npm i -g ajv-cli@5
      - name: Validate agent workflow manifests
        shell: bash
        env:
          SCHEMA_REF: contracts-v1
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=()
          while IFS= read -r -d '' f; do files+=("$f"); done < <(find agents -type f -name '*.workflow.json' -print0 2>/dev/null || true)
          while IFS= read -r -d '' f; do files+=("$f"); done < <(find . -type f -name '*.agent.workflow.json' -print0 2>/dev/null || true)
          if (( ${#files[@]} == 0 )); then
            echo "::notice::No agent workflow manifests found."
            exit 0
          fi
          curl -fsSL "https://raw.githubusercontent.com/heimgewebe/metarepo/${SCHEMA_REF}/contracts/agent.workflow.schema.json" -o /tmp/schema.json
          for f in "${files[@]}"; do
            echo "â†’ $f"
            ajv validate --spec=draft2020 --strict=true --validate-formats=true -s /tmp/schema.json -d "$f"
          done
