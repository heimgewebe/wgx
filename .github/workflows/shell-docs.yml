name: shell-docs
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  shell-and-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      # Pinned to a known-good version to ensure reliable CI builds
      VALE_VERSION: "v3.5.0"
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get -yq update
          sudo apt-get -yq install shellcheck shfmt bats jq
          npm install -g markdownlint-cli2@0.14.0

          # Function to attempt installation of a specific version
          install_vale() {
            local version_tag="$1"
            
            # Validate version_tag is not empty
            if [[ -z "$version_tag" ]]; then
              echo "::error::Vale version tag is empty. Aborting."
              return 1
            fi
            
            echo "Attempting to install Vale ${version_tag}..."

            local version_num="${version_tag#v}"
            local base_url="https://github.com/errata-ai/vale/releases/download/${version_tag}"
            local sum_name="vale_${version_num}_checksums.txt"
            local tmpdir
            tmpdir="$(mktemp -d)"

            # Try multiple naming patterns for Linux x86_64
            local tar_names=(
              "vale_${version_num}_Linux_64-bit.tar.gz"
              "vale_${version_num}_Linux_x86_64.tar.gz"
              "vale_${version_num}_linux_amd64.tar.gz"
              "vale_${version_num}_Linux_amd64.tar.gz"
              "vale_${version_num}_linux_64-bit.tar.gz"
              "vale_${version_num}_linux_x86_64.tar.gz"
              "vale_${version_num}_Linux_x86-64.tar.gz"
              "vale_${version_num}_linux_x86-64.tar.gz"
            )

            # 1. Download checksums
            echo "Vale release base URL: ${base_url}"
            echo "Downloading checksums from: ${base_url}/${sum_name}"
            if ! curl --retry 3 --retry-delay 5 -fsSL "${base_url}/${sum_name}" -o "$tmpdir/checksums.txt"; then
              local curl_exit_code=$?
              echo "::error::Curl failed with exit code $curl_exit_code"
              echo "::error::Failed to download checksums file from ${base_url}/${sum_name}"
              rm -rf "$tmpdir"
              return 1
            fi

            # Validate checksums file was actually downloaded and is not empty
            if [[ ! -s "$tmpdir/checksums.txt" ]]; then
              echo "::error::Checksums file is empty or missing - URL may be incorrect"
              rm -rf "$tmpdir"
              return 1
            fi
            echo "Checksums file downloaded successfully"

            # 2. Determine tarball name
            local tar_name=""
            for candidate in "${tar_names[@]}"; do
              if grep -q "$candidate" "$tmpdir/checksums.txt"; then
                tar_name="$candidate"
                echo "Found matching tarball name: $tar_name"
                break
              fi
            done

            if [[ -z "$tar_name" ]]; then
              echo "No exact match found in predefined names. Searching in checksums.txt..."
              tar_name=$(grep -iE 'Linux.*(64-bit|x86_64|x86-64|amd64).*\.tar\.gz' "$tmpdir/checksums.txt" | awk '{print $2}' | head -1)
              if [[ -n "$tar_name" ]]; then
                echo "Auto-detected tarball name: $tar_name"
              fi
            fi

            if [[ -z "$tar_name" ]]; then
              echo "::error::Could not determine Vale tarball name for ${version_tag}"
              echo "Available files in checksums.txt (first 20 lines):"
              head -20 "$tmpdir/checksums.txt"
              rm -rf "$tmpdir"
              return 1
            fi

            # 3. Download tarball
            echo "Downloading tarball from: ${base_url}/${tar_name}"
            if ! curl --retry 3 --retry-delay 5 -fsSL "${base_url}/${tar_name}" -o "$tmpdir/vale.tar.gz"; then
              local curl_exit_code=$?
              echo "::error::Curl failed with exit code $curl_exit_code"
              echo "::error::Failed to download tarball from ${base_url}/${tar_name}"
              rm -rf "$tmpdir"
              return 1
            fi
            echo "Tarball downloaded successfully"

            # 4. Verify Checksum
            echo "Looking for checksum of: $tar_name"
            local expected_sha=""
            expected_sha=$(awk -v tar="$tar_name" '$2 == tar {print $1}' "$tmpdir/checksums.txt")
            if [[ -z "$expected_sha" ]]; then
              echo "Exact match not found. Trying partial match..."
              expected_sha=$(awk -v tar="$tar_name" 'index($2, tar) || index($0, tar) {print $1}' "$tmpdir/checksums.txt" | head -1)
            fi
            if [[ -z "$expected_sha" ]]; then
              echo "::error::Failed to extract expected SHA256 from checksums.txt for ${version_tag}"
              echo "Available checksums in file (first 20 lines):"
              head -20 "$tmpdir/checksums.txt"
              rm -rf "$tmpdir"
              return 1
            fi

            local actual_sha=""
            actual_sha=$(sha256sum "$tmpdir/vale.tar.gz" | awk '{print $1}')
            if [ "$expected_sha" != "$actual_sha" ]; then
              echo "::error::Vale checksum mismatch: expected $expected_sha, got $actual_sha"
              rm -rf "$tmpdir"
              return 1
            fi
            echo "Checksum verified successfully"

            # 5. Install
            echo "Extracting and installing Vale..."
            tar xz -C "$tmpdir" -f "$tmpdir/vale.tar.gz"
            sudo mv "$tmpdir/vale" /usr/local/bin/vale
            rm -rf "$tmpdir"
            echo "Vale ${version_tag} installed successfully"
            return 0
          }

          # Ensure VALE_VERSION is set and not empty
          : "${VALE_VERSION:?Vale version not set or empty}"
          
          echo "Installing pinned Vale version: $VALE_VERSION"
          if ! install_vale "$VALE_VERSION"; then
            echo "::error::Failed to install Vale version $VALE_VERSION"
            exit 1
          fi

          vale --version
      - name: Lint shells
        run: |
          set -euo pipefail
          mapfile -t files < <(git ls-files '*.sh' '*.bash')
          if [[ ${#files[@]} -eq 0 ]]; then
            echo "No shell files found."
            exit 0
          fi
          bash -n "${files[@]}"
          shfmt -d "${files[@]}"
          shellcheck -S style "${files[@]}"
      - name: Test (bats)
        run: |
          if [ -d tests ]; then
            bats -r tests
          else
            echo "No tests directory" && exit 0
          fi
      - name: Lint markdown
        run: |
          set -euo pipefail
          mapfile -t md_files < <(git ls-files '*.md' '*.mdx')
          if [[ ${#md_files[@]} -eq 0 ]]; then
            echo "No markdown files."
            exit 0
          fi
          markdownlint-cli2 "${md_files[@]}"
          vale .

  python-uv:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Check for Python project
        id: check-python
        run: |
          has_uv_lock=false
          has_pyproject=false
          if [ -f uv.lock ]; then
            has_uv_lock=true
          fi
          if find . -name 'pyproject.toml' -type f | grep -q .; then
            has_pyproject=true
          fi
          if [ "$has_uv_lock" = "true" ] && [ "$has_pyproject" = "true" ]; then
            echo "has_python=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_python=false" >> "$GITHUB_OUTPUT"
            echo "::notice::No uv.lock or pyproject.toml found, skipping Python checks"
          fi
      - name: Install uv
        if: steps.check-python.outputs.has_python == 'true'
        run: |
          set -euo pipefail
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >>"$GITHUB_PATH"
          uv_version="$("$HOME/.local/bin/uv" --version | awk '{print $2}')"
          echo "UV_VERSION=${uv_version}" >>"$GITHUB_ENV"
      - name: Cache uv
        if: steps.check-python.outputs.has_python == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ env.UV_VERSION || 'latest' }}-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}
      - name: Sync deps (frozen)
        if: steps.check-python.outputs.has_python == 'true'
        run: ~/.local/bin/uv sync --frozen
      - name: Smoke run
        if: steps.check-python.outputs.has_python == 'true'
        run: ~/.local/bin/uv run python -c "print('uv ok')"
