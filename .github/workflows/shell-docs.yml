name: shell-docs
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  shell-and-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      VALE_FALLBACK_VERSION: "v3.5.0"
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get -yq update
          sudo apt-get -yq install shellcheck shfmt bats jq
          npm install -g markdownlint-cli2@0.14.0

          # 1. Fetch latest version tag from GitHub API
          VALE_TAG=$(curl -sL --fail --max-time 30 https://api.github.com/repos/errata-ai/vale/releases/latest | jq -r .tag_name)
          if [[ -z "$VALE_TAG" || "$VALE_TAG" == "null" ]]; then
            # fallback to a pinned Vale version
            VALE_TAG="${VALE_FALLBACK_VERSION}"
            echo "Warning: Using fallback Vale version $VALE_TAG."
          else
            echo "Detected latest Vale version: $VALE_TAG"
          fi

          # 2. Construct URLs for the latest release
          # Pattern: vale_X.Y.Z_Linux_64-bit.tar.gz and vale_X.Y.Z_checksums.txt
          VERSION_NUM="${VALE_TAG#v}"
          BASE_URL="https://github.com/errata-ai/vale/releases/download/${VALE_TAG}"
          
          # Try multiple naming patterns for Linux x86_64
          TAR_NAMES=(
            "vale_${VERSION_NUM}_Linux_64-bit.tar.gz"
            "vale_${VERSION_NUM}_Linux_x86_64.tar.gz"
            "vale_${VERSION_NUM}_linux_amd64.tar.gz"
          )
          SUM_NAME="vale_${VERSION_NUM}_checksums.txt"

          tmpdir="$(mktemp -d)"
          
          # Download checksums first to determine correct filename
          echo "Downloading $SUM_NAME..."
          if ! curl -fsSL "${BASE_URL}/${SUM_NAME}" -o "$tmpdir/checksums.txt"; then
            echo "::error::Failed to download checksums file"
            rm -rf "$tmpdir"
            exit 1
          fi
          
          echo "Contents of checksums.txt:"
          cat "$tmpdir/checksums.txt"
          
          # Find the correct Linux x86_64 tarball name from checksums
          TAR_NAME=""
          for candidate in "${TAR_NAMES[@]}"; do
            if grep -q "$candidate" "$tmpdir/checksums.txt"; then
              TAR_NAME="$candidate"
              echo "Found matching tarball name: $TAR_NAME"
              break
            fi
          done
          
          # If no exact match, try to extract from checksums.txt
          if [[ -z "$TAR_NAME" ]]; then
            echo "::warning::No exact match found in predefined names. Searching in checksums.txt..."
            TAR_NAME=$(grep -iE 'Linux.*(64-bit|x86_64|amd64).*\.tar\.gz' "$tmpdir/checksums.txt" | awk '{print $2}' | head -1)
            if [[ -n "$TAR_NAME" ]]; then
              echo "Auto-detected tarball name: $TAR_NAME"
            fi
          fi
          
          if [[ -z "$TAR_NAME" ]]; then
            echo "::error::Could not determine Vale tarball name for Linux x86_64"
            echo "Available files in checksums.txt:"
            cat "$tmpdir/checksums.txt"
            rm -rf "$tmpdir"
            exit 1
          fi
          
          echo "Downloading $TAR_NAME..."
          if ! curl -fsSL "${BASE_URL}/${TAR_NAME}" -o "$tmpdir/vale.tar.gz"; then
            echo "::error::Failed to download $TAR_NAME"
            rm -rf "$tmpdir"
            exit 1
          fi

          # 3. Verify Checksum
          echo "Looking for checksum of: $TAR_NAME"
          expected_sha=$(awk -v tar="$TAR_NAME" '$2 == tar {print $1}' "$tmpdir/checksums.txt")
          if [[ -z "$expected_sha" ]]; then
            echo "::warning::Exact match not found. Trying partial match..."
            # Try partial match in case filename format differs slightly
            expected_sha=$(awk -v tar="$TAR_NAME" 'index($2, tar) || index($0, tar) {print $1}' "$tmpdir/checksums.txt" | head -1)
          fi
          if [[ -z "$expected_sha" ]]; then
            echo "::error::Failed to extract expected SHA256 from checksums.txt for $VALE_TAG"
            echo "Searched for: $TAR_NAME"
            rm -rf "$tmpdir"
            exit 1
          fi
          echo "Found expected SHA256: $expected_sha"

          actual_sha=$(sha256sum "$tmpdir/vale.tar.gz" | awk '{print $1}')
          if [ "$expected_sha" != "$actual_sha" ]; then
            echo "::error::Vale checksum mismatch: expected $expected_sha, got $actual_sha"
            exit 1
          fi

          # 4. Install
          tar xz -C "$tmpdir" -f "$tmpdir/vale.tar.gz"
          sudo mv "$tmpdir/vale" /usr/local/bin/vale
          rm -rf "$tmpdir"
          vale --version
      - name: Lint shells
        run: |
          set -euo pipefail
          mapfile -t files < <(git ls-files '*.sh' '*.bash')
          if [[ ${#files[@]} -eq 0 ]]; then
            echo "No shell files found."
            exit 0
          fi
          bash -n "${files[@]}"
          shfmt -d "${files[@]}"
          shellcheck -S style "${files[@]}"
      - name: Test (bats)
        run: |
          if [ -d tests ]; then
            bats -r tests
          else
            echo "No tests directory" && exit 0
          fi
      - name: Lint markdown
        run: |
          set -euo pipefail
          mapfile -t md_files < <(git ls-files '*.md' '*.mdx')
          if [[ ${#md_files[@]} -eq 0 ]]; then
            echo "No markdown files."
            exit 0
          fi
          markdownlint-cli2 "${md_files[@]}"
          vale .

  python-uv:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Check for Python project
        id: check-python
        run: |
          has_uv_lock=false
          has_pyproject=false
          if [ -f uv.lock ]; then
            has_uv_lock=true
          fi
          if find . -name 'pyproject.toml' -type f | grep -q .; then
            has_pyproject=true
          fi
          if [ "$has_uv_lock" = "true" ] && [ "$has_pyproject" = "true" ]; then
            echo "has_python=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_python=false" >> "$GITHUB_OUTPUT"
            echo "::notice::No uv.lock or pyproject.toml found, skipping Python checks"
          fi
      - name: Install uv
        if: steps.check-python.outputs.has_python == 'true'
        run: |
          set -euo pipefail
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >>"$GITHUB_PATH"
          uv_version="$("$HOME/.local/bin/uv" --version | awk '{print $2}')"
          echo "UV_VERSION=${uv_version}" >>"$GITHUB_ENV"
      - name: Cache uv
        if: steps.check-python.outputs.has_python == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ env.UV_VERSION || 'latest' }}-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}
      - name: Sync deps (frozen)
        if: steps.check-python.outputs.has_python == 'true'
        run: ~/.local/bin/uv sync --frozen
      - name: Smoke run
        if: steps.check-python.outputs.has_python == 'true'
        run: ~/.local/bin/uv run python -c "print('uv ok')"
