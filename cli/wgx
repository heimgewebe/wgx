#!/usr/bin/env bash
set -e
set -u
if ! set -o pipefail 2>/dev/null; then
  if [[ ${WGX_DEBUG:-0} != 0 ]]; then
    echo "WGX: 'pipefail' wird von dieser Shell nicht unterstützt; fahre ohne fort." >&2
  fi
fi

# Rolle: Zentraler Einstiegspunkt (Dispatcher)
# Dieses Skript ist der einzige direkte Einstiegspunkt für alle `wgx`-Aufrufe.
# Es ermittelt das Repo-Root, lädt Bibliotheken aus `lib/` und `modules/`
# und leitet die Ausführung an das passende Subkommando in `cmd/` weiter.
#
# WGX_DIR auf Root des Repos setzen, falls nicht bereits gesetzt.
# Das ermöglicht es Tests, das Verzeichnis für eine isolierte Umgebung vorzugeben.
if [ -z "${WGX_DIR:-}" ]; then
  # Robuste Symlink-Auflösung
  SOURCE="${BASH_SOURCE[0]}"
  while [ -h "$SOURCE" ]; do
    DIR="$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)"
    TARGET="$(readlink "$SOURCE")"
    [[ "$TARGET" != /* ]] && TARGET="$DIR/$TARGET"
    SOURCE="$TARGET"
  done
  DIR="$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)"
  WGX_DIR="$(cd -P "$DIR/.." >/dev/null 2>&1 && pwd)"
fi
export WGX_DIR

# Version anzeigen, bevor weitere Komponenten geladen werden
__WGX_VERSION__="2.0.3"
export WGX_VERSION="$__WGX_VERSION__"
case "${1:-}" in
--version | -V)
  echo "wgx ${__WGX_VERSION__}"
  exit 0
  ;;
esac

# libs laden (alphabetisch hält Ordnung)
# WGX_PROJECT_ROOT wird in Tests gesetzt, um die Bibliotheken zu finden.
# Im Normalbetrieb ist es nicht gesetzt und der Fallback auf WGX_DIR wird verwendet.
LIB_DIR="${WGX_PROJECT_ROOT:-$WGX_DIR}/lib"
if [ -d "$LIB_DIR" ]; then
  for f in "$LIB_DIR"/*.bash; do
    if [ -r "$f" ]; then
      if [[ ${WGX_DEBUG:-0} != 0 ]]; then
        echo "Loading library: $f" >&2
      fi
      # shellcheck disable=SC1090
      if ! source "$f"; then
        echo "Error: Failed to source library file: $f" >&2
        exit 1
      fi
    fi
  done
fi

# Default-Branch / Basis für Reload
: "${WGX_BASE:=main}"

# Initialisiert das Profil-Modul, nachdem alle Bibliotheken geladen wurden
if declare -F profile::_auto_init >/dev/null 2>&1; then
  profile::_auto_init
fi

# Haupteinstieg
wgx_main "$@"
